name: Deploy Worker Script

on:
  push:
    tags:
      - '*'  # 当任何标签被推送时触发

jobs:
  deploy-worker:
    runs-on: ubuntu-latest
    
    steps:
      - name: Get tag name
        id: get_tag
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "当前标签: $TAG_NAME"
      
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 需要完整的Git历史来获取标签信息
      
      - name: Get and checkout default branch
        id: get_branch
        run: |
          # 检测主分支名称（可能是main或master）
          if git show-ref --verify --quiet refs/remotes/origin/main; then
            BRANCH_NAME="main"
          elif git show-ref --verify --quiet refs/remotes/origin/master; then
            BRANCH_NAME="master"
          else
            # 尝试获取默认分支
            BRANCH_NAME=$(git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@^refs/remotes/origin/@@' || echo "main")
          fi
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "默认分支: $BRANCH_NAME"
          # 检出主分支
          git checkout $BRANCH_NAME
          git pull origin $BRANCH_NAME || true
          echo "已切换到分支: $BRANCH_NAME"
      
      - name: Check if source file exists
        run: |
          if [ ! -f "少年你相信光吗" ]; then
            echo "错误：在项目根目录未找到 '少年你相信光吗' 文件。"
            exit 1
          fi
          echo "成功找到源文件 '少年你相信光吗'"
      
      - name: Rename file to _worker.js
        run: |
          cp "少年你相信光吗" "_worker.js"
          echo "成功将 '少年你相信光吗' 复制为 '_worker.js'"
      
      - name: Commit _worker.js file
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add "_worker.js"
          if git diff --staged --quiet; then
            echo "文件 '_worker.js' 没有变化，跳过提交。"
          else
            git commit -m "部署: 更新 _worker.js 文件 (标签: ${{ steps.get_tag.outputs.tag_name }})"
            git push origin ${{ steps.get_branch.outputs.branch_name }}
          fi
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_tag.outputs.tag_name }}
          name: Release ${{ steps.get_tag.outputs.tag_name }}
          body: |
            ## 部署信息
            
            - **源文件**: 少年你相信光吗
            - **目标文件**: _worker.js
            - **标签**: ${{ steps.get_tag.outputs.tag_name }}
            - **部署时间**: ${{ github.event.head_commit.timestamp }}
            
            ## 文件变更
            
            已从 `少年你相信光吗` 生成 `_worker.js` 文件。
          draft: false
          prerelease: false
          files: _worker.js
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Output summary
        run: |
          echo "## 部署完成" >> $GITHUB_STEP_SUMMARY
          echo "- 源文件: 少年你相信光吗" >> $GITHUB_STEP_SUMMARY
          echo "- 目标文件: _worker.js" >> $GITHUB_STEP_SUMMARY
          echo "- 标签: ${{ steps.get_tag.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub Release 已创建" >> $GITHUB_STEP_SUMMARY

